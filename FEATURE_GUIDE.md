# 费用管理功能使用指南

## 功能概述
费用管理功能允许用户为每个旅行计划开设独立的账本，支持对账目进行增删改查操作。每个账目包含开销内容和金额两个核心字段，同时还支持分类管理和预算监控。

## 主要特性

### 1. 计划费用概览
- 实时显示旅行计划的总预算、当前支出、剩余预算
- 预算超支预警（红色标识）
- 详细费用统计信息

### 2. 费用记录管理
- **添加费用**：记录各项开销，包括内容、金额、分类、日期
- **编辑费用**：修改已记录的费用信息
- **删除费用**：移除不需要的费用记录
- **查看费用**：按时间顺序查看所有费用记录

### 3. 费用分类统计
- 自动计算各分类费用占比
- 可视化进度条显示分类占比
- 支持7种分类：交通、住宿、餐饮、景点门票、购物、娱乐、其他

### 4. 预算监控
- 实时计算总支出和平均支出
- 剩余预算显示
- 超支预警功能

## 使用流程

### 1. 访问费用管理页面
1. 登录系统后，进入"我的旅行计划"页面
2. 在计划卡片上点击"费用管理"按钮
3. 系统自动跳转到费用管理页面

### 2. 添加费用记录
1. 点击"添加费用"按钮
2. 填写费用信息：
   - **开销内容**：必填，描述具体花费内容
   - **金额**：必填，支持小数点后两位
   - **分类**：必选，从7个分类中选择
   - **日期**：必填，默认为当天
3. 点击"保存"完成添加

### 3. 管理费用记录
- **编辑**：点击费用记录旁边的"编辑"按钮
- **删除**：点击费用记录旁边的"删除"按钮，需确认操作
- **查看**：表格自动按时间倒序排列，最新记录显示在最上面

### 4. 查看统计信息
- 费用管理页面顶部显示计划预算和支出概览
- 中间部分显示费用统计：总费用、记录数量、平均费用、预算剩余
- 底部显示费用分类统计图表

## 数据库表结构

### expenses 表结构
```sql
CREATE TABLE expenses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    plan_id UUID NOT NULL REFERENCES travel_plans(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    content VARCHAR(100) NOT NULL,
    amount DECIMAL(10,2) NOT NULL CHECK (amount >= 0),
    category VARCHAR(20) NOT NULL CHECK (category IN ('交通', '住宿', '餐饮', '景点门票', '购物', '娱乐', '其他')),
    date DATE NOT NULL DEFAULT CURRENT_DATE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## 技术实现

### 前端组件
- **位置**：`src/views/expense/index.vue`
- **技术栈**：Vue 3 + TypeScript + Element Plus
- **主要功能**：
  - 费用记录的增删改查
  - 实时统计计算
  - 分类数据分析
  - 用户界面交互

### 后端服务
- **位置**：`src/lib/expense-service.ts`
- **主要接口**：
  - `getExpensesByPlan(planId)` - 获取指定计划的费用记录
  - `addExpense(expense)` - 添加费用记录
  - `updateExpense(expenseId, expense)` - 更新费用记录
  - `deleteExpense(expenseId)` - 删除费用记录
  - `getExpenseStats(planId)` - 获取费用统计

### 路由配置
- **路径**：`/expense`
- **参数**：`planId` - 计划ID，通过query参数传递
- **访问方式**：从计划列表页面跳转

## 安全策略

### 权限控制
- 用户只能访问自己创建的计划费用
- 基于用户ID进行数据隔离
- 删除操作需要确认，防止误操作

### 数据验证
- 金额必须大于等于0
- 分类必须在预设范围内
- 日期格式验证
- 内容长度限制（100字符）

## 使用示例

### 典型场景：记录一次旅行费用
1. 用户创建"日本东京5日游"计划
2. 完成行程规划后，进入费用管理页面
3. 添加各项费用：
   - 机票：1500元（交通）
   - 酒店：800元/晚 × 4晚 = 3200元（住宿）
   - 餐饮：每日约200元 × 5天 = 1000元（餐饮）
   - 景点门票：500元（景点门票）
   - 购物：1500元（购物）
4. 系统自动计算总支出：7700元
5. 查看分类统计，了解各类费用占比

### 预算控制场景
- 设置总预算为10000元
- 实时监控剩余预算：10000 - 7700 = 2300元
- 如果某项费用超支，系统会给出提示

## 扩展功能建议

### 未来可扩展的功能
1. **费用导入导出**：支持CSV/Excel格式
2. **费用分摊**：多人旅行费用分摊计算
3. **货币转换**：支持多种货币自动转换
4. **费用报表**：生成详细的费用分析报告
5. **智能分类**：基于内容自动分类费用
6. **预算提醒**：接近预算时发送提醒

## 注意事项

1. **数据备份**：定期备份费用数据
2. **权限管理**：确保只有授权用户能访问数据
3. **性能优化**：大量数据时考虑分页加载
4. **移动端适配**：确保在移动设备上体验良好

## 故障排除

### 常见问题
1. **无法添加费用**：检查网络连接和用户登录状态
2. **费用统计不准确**：确认金额输入格式正确
3. **分类显示异常**：刷新页面或检查分类数据

### 技术支持
如遇到技术问题，请检查：
- 控制台错误信息
- 网络请求状态
- 数据库连接状态